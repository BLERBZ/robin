name: OS Project Health Check

on:
  schedule:
    - cron: '0 9 * * 1'  # Weekly on Monday at 9 AM UTC
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run Health Checks
        env:
          KAIT_GITHUB_TOKEN: ${{ secrets.KAIT_GITHUB_TOKEN }}
          KAIT_GITHUB_ORG: ${{ vars.KAIT_GITHUB_ORG || 'blerbz' }}
        run: |
          python -c "
          from lib.os_project_manager import get_os_project_manager
          from lib.os_learning import get_os_learning

          mgr = get_os_project_manager()
          engine = get_os_learning()

          projects = mgr.list_projects()
          for p in projects:
              print(f'--- Health Check: {p.slug} ---')
              checks = mgr.health_check(p.slug)
              print(f'Score: {checks.get(\"score\", \"N/A\")}')
              print(f'Health: {checks.get(\"health\", \"unknown\")}')

              # Run learning cycle
              insights = engine.learn_from_project(p.slug)
              print(f'New insights: {len(insights)}')
              print()
          "

      - name: Run Mastery Report
        env:
          KAIT_GITHUB_TOKEN: ${{ secrets.KAIT_GITHUB_TOKEN }}
          KAIT_GITHUB_ORG: ${{ vars.KAIT_GITHUB_ORG || 'blerbz' }}
        run: |
          python -c "
          from lib.os_learning import get_os_learning
          engine = get_os_learning()
          report = engine.get_mastery_report()
          print(f'Overall Level: {report[\"overall_level\"]}')
          print(f'Overall Score: {report[\"overall_score\"]}%')
          "
