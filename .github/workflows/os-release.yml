name: OS Release Pipeline

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project slug to release'
        required: true
        type: string
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Prepare and Execute Release
        env:
          KAIT_GITHUB_TOKEN: ${{ secrets.KAIT_GITHUB_TOKEN }}
          KAIT_GITHUB_ORG: ${{ vars.KAIT_GITHUB_ORG || 'blerbz' }}
        run: |
          python -c "
          from lib.release_pipeline import get_release_pipeline, BumpType
          pipeline = get_release_pipeline()
          bump = BumpType('${{ inputs.bump_type }}')
          prep = pipeline.prepare_release('${{ inputs.project }}', bump)
          print(f'Releasing: ${{ inputs.project }} v{prep.current_version} -> v{prep.next_version}')
          results = pipeline.execute_release(prep)
          print(f'Status: {results.get(\"status\")}')
          if results.get('release_url'):
              print(f'URL: {results[\"release_url\"]}')

          # Generate announcements
          announcements = pipeline.generate_announcement(prep)
          print(f'Announcement summary: {announcements[\"summary\"]}')
          "

      - name: Post Release Summary
        if: success()
        run: echo "Release completed successfully"
